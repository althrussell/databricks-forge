// Databricks Forge AI — Prisma Schema
//
// Connects to Lakebase Autoscaling (Postgres-compatible).
// Tables store pipeline run state, discovered use cases, and export history.

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ---------------------------------------------------------------------------
// Pipeline Runs
// ---------------------------------------------------------------------------

model ForgeRun {
  runId              String    @id @map("run_id")
  businessName       String    @map("business_name")
  ucMetadata         String    @map("uc_metadata")
  operation          String    @default("Discover Usecases")
  businessPriorities String?   @map("business_priorities")
  strategicGoals     String?   @map("strategic_goals")
  businessDomains    String?   @map("business_domains")
  aiModel            String?   @default("databricks-claude-opus-4-6") @map("ai_model")
  languages          String?   @default("[\"English\"]")
  generationOptions  String?   @default("[\"SQL Code\"]") @map("generation_options")
  generationPath     String?   @default("./forge_gen/") @map("generation_path")
  status             String    @default("pending")
  currentStep        String?   @map("current_step")
  progressPct        Int       @default(0) @map("progress_pct")
  statusMessage      String?   @map("status_message")
  businessContext    String?   @map("business_context")
  errorMessage       String?   @map("error_message")
  createdAt          DateTime  @default(now()) @map("created_at")
  completedAt        DateTime? @map("completed_at")

  createdBy          String?   @map("created_by")
  filteredTablesJson String?   @map("filtered_tables_json")
  metadataCacheKey   String?   @map("metadata_cache_key")

  useCases             ForgeUseCase[]
  exports              ForgeExport[]
  promptLogs           ForgePromptLog[]
  genieRecommendations     ForgeGenieRecommendation[]
  genieSpaces              ForgeGenieSpace[]
  genieEngineConfigs       ForgeGenieEngineConfig[]
  dashboardRecommendations ForgeDashboardRecommendation[]
  dashboards               ForgeDashboard[]
  backgroundJobs           ForgeBackgroundJob[]
  environmentScans         ForgeEnvironmentScan[]
  discoveredGenieSpaces    ForgeDiscoveredGenieSpace[]
  discoveredDashboards     ForgeDiscoveredDashboard[]
  assetCoverages           ForgeAssetCoverage[]

  @@map("forge_runs")
}

// ---------------------------------------------------------------------------
// Use Cases
// ---------------------------------------------------------------------------

model ForgeUseCase {
  id                 String  @id
  runId              String  @map("run_id")
  useCaseNo          Int?    @map("use_case_no")
  name               String?
  type               String?
  analyticsTechnique String? @map("analytics_technique")
  statement          String?
  solution           String?
  businessValue      String? @map("business_value")
  beneficiary        String?
  sponsor            String?
  domain             String?
  subdomain          String?
  tablesInvolved     String? @map("tables_involved")
  priorityScore          Float?  @map("priority_score")
  feasibilityScore       Float?  @map("feasibility_score")
  impactScore            Float?  @map("impact_score")
  overallScore           Float?  @map("overall_score")
  userPriorityScore      Float?  @map("user_priority_score")
  userFeasibilityScore   Float?  @map("user_feasibility_score")
  userImpactScore        Float?  @map("user_impact_score")
  userOverallScore       Float?  @map("user_overall_score")
  sqlCode                String? @map("sql_code")
  sqlStatus              String? @map("sql_status")
  feedback               String?                              // "accepted" | "rejected" | "dismissed"
  feedbackAt             DateTime? @map("feedback_at")

  run ForgeRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@index([runId])
  @@map("forge_use_cases")
}

// ---------------------------------------------------------------------------
// Prompt Audit Log
// ---------------------------------------------------------------------------

model ForgePromptLog {
  logId            String   @id @map("log_id")
  runId            String   @map("run_id")
  step             String
  promptKey        String   @map("prompt_key")
  promptVersion    String   @map("prompt_version")
  model            String
  temperature      Float
  renderedPrompt   String   @map("rendered_prompt")
  rawResponse      String?  @map("raw_response")
  honestyScore     Float?   @map("honesty_score")
  durationMs       Int?     @map("duration_ms")
  promptTokens     Int?     @map("prompt_tokens")
  completionTokens Int?     @map("completion_tokens")
  totalTokens      Int?     @map("total_tokens")
  success          Boolean  @default(true)
  errorMessage     String?  @map("error_message")
  createdAt        DateTime @default(now()) @map("created_at")

  run ForgeRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@index([runId])
  @@index([runId, step])
  @@map("forge_prompt_logs")
}

// ---------------------------------------------------------------------------
// Prompt Template Archive (content-addressable)
// ---------------------------------------------------------------------------

model ForgePromptTemplate {
  versionHash  String   @id @map("version_hash")
  promptKey    String   @map("prompt_key")
  templateText String   @map("template_text")
  charCount    Int      @map("char_count")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([promptKey])
  @@map("forge_prompt_templates")
}

// ---------------------------------------------------------------------------
// Activity Log
// ---------------------------------------------------------------------------

model ForgeActivityLog {
  activityId String   @id @map("activity_id")
  userId     String?  @map("user_id")
  action     String                              // created_run, deleted_run, exported, started_pipeline, completed, failed
  resourceId String?  @map("resource_id")        // runId or exportId
  metadata   String?                             // JSON metadata
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([resourceId])
  @@map("forge_activity_log")
}

// ---------------------------------------------------------------------------
// Metadata Cache
// ---------------------------------------------------------------------------

model ForgeMetadataCache {
  cacheKey     String   @id @map("cache_key")
  ucPath       String?  @map("uc_path")
  metadataJson String?  @map("metadata_json")
  tableCount   Int?     @map("table_count")
  columnCount  Int?     @map("column_count")
  cachedAt     DateTime @default(now()) @map("cached_at")

  @@index([cachedAt])
  @@map("forge_metadata_cache")
}

// ---------------------------------------------------------------------------
// Custom Outcome Maps
// ---------------------------------------------------------------------------

model ForgeOutcomeMap {
  id           String   @id @map("outcome_map_id")
  industryId   String   @unique @map("industry_id")
  name         String
  rawMarkdown  String   @map("raw_markdown")
  parsedJson   String   @map("parsed_json")
  useCaseCount Int      @default(0) @map("use_case_count")
  createdBy    String?  @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([createdAt])
  @@map("forge_outcome_maps")
}

// ---------------------------------------------------------------------------
// Genie Space Recommendations (generated in pipeline)
// ---------------------------------------------------------------------------

model ForgeGenieRecommendation {
  id                  String   @id @map("recommendation_id")
  runId               String   @map("run_id")
  domain              String
  subdomains          String?                              // JSON array
  title               String
  description         String
  tableCount          Int      @default(0) @map("table_count")
  metricViewCount     Int      @default(0) @map("metric_view_count")
  useCaseCount        Int      @default(0) @map("use_case_count")
  sqlExampleCount     Int      @default(0) @map("sql_example_count")
  joinCount           Int      @default(0) @map("join_count")
  measureCount        Int      @default(0) @map("measure_count")
  filterCount         Int      @default(0) @map("filter_count")
  dimensionCount      Int      @default(0) @map("dimension_count")
  tables              String?                              // JSON array of FQNs
  metricViews         String?  @map("metric_views")        // JSON array of FQNs
  serializedSpace     String   @map("serialized_space")    // JSON for Genie API
  benchmarks          String?                              // JSON: BenchmarkQuestion[]
  columnEnrichments   String?  @map("column_enrichments")  // JSON: ColumnEnrichment[]
  metricViewProposals String?  @map("metric_view_proposals") // JSON: MetricViewProposal[]
  trustedFunctions    String?  @map("trusted_functions")     // JSON: TrustedAssetFunction[]
  engineConfigVersion Int      @default(0) @map("engine_config_version")
  recommendationType  String   @default("new") @map("recommendation_type") // new | enhancement | replacement
  existingAssetId     String?  @map("existing_asset_id")
  changeSummary       String?  @map("change_summary")
  createdAt           DateTime @default(now()) @map("created_at")

  run ForgeRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@unique([runId, domain])
  @@index([runId])
  @@map("forge_genie_recommendations")
}

// ---------------------------------------------------------------------------
// Genie Engine Configuration (per-run, customer-editable)
// ---------------------------------------------------------------------------

model ForgeGenieEngineConfig {
  id        String   @id @map("config_id")
  runId     String   @map("run_id")
  version   Int      @default(1)
  config    String                                       // JSON: GenieEngineConfig
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  run ForgeRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@unique([runId])
  @@index([runId])
  @@map("forge_genie_engine_configs")
}

// ---------------------------------------------------------------------------
// Genie Spaces (tracking)
// ---------------------------------------------------------------------------

model ForgeGenieSpace {
  id                 String   @id @map("genie_tracking_id")
  spaceId            String   @map("space_id")
  runId              String   @map("run_id")
  domain             String
  title              String
  status             String   @default("created") // created | updated | trashed
  deployedAssetsJson String?  @map("deployed_assets_json")
  authMode           String?  @map("auth_mode") // "obo" | "sp" — null for legacy rows (treated as "sp")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at")

  run ForgeRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@unique([runId, domain])
  @@index([runId])
  @@index([spaceId])
  @@map("forge_genie_spaces")
}

// ---------------------------------------------------------------------------
// Dashboard Recommendations (generated in pipeline)
// ---------------------------------------------------------------------------

model ForgeDashboardRecommendation {
  id                  String   @id @map("recommendation_id")
  runId               String   @map("run_id")
  domain              String
  subdomains          String?                              // JSON array
  title               String
  description         String
  datasetCount        Int      @default(0) @map("dataset_count")
  widgetCount         Int      @default(0) @map("widget_count")
  useCaseIds          String?  @map("use_case_ids")        // JSON array
  serializedDashboard String   @map("serialized_dashboard") // Lakeview JSON
  dashboardDesign     String?  @map("dashboard_design")     // JSON: DashboardDesign
  recommendationType  String   @default("new") @map("recommendation_type") // new | enhancement | replacement
  existingAssetId     String?  @map("existing_asset_id")
  changeSummary       String?  @map("change_summary")
  createdAt           DateTime @default(now()) @map("created_at")

  run ForgeRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@unique([runId, domain])
  @@index([runId])
  @@map("forge_dashboard_recommendations")
}

// ---------------------------------------------------------------------------
// Dashboards (tracking)
// ---------------------------------------------------------------------------

model ForgeDashboard {
  id           String   @id @map("dashboard_tracking_id")
  dashboardId  String   @map("dashboard_id")
  runId        String   @map("run_id")
  domain       String
  title        String
  status       String   @default("created") // created | updated | trashed
  dashboardUrl String?  @map("dashboard_url")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  run ForgeRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@unique([runId, domain])
  @@index([runId])
  @@index([dashboardId])
  @@map("forge_dashboards")
}

// ---------------------------------------------------------------------------
// Background Jobs (engine status persistence)
// ---------------------------------------------------------------------------

model ForgeBackgroundJob {
  id          String    @id @map("job_id")
  runId       String    @map("run_id")
  engine      String    // "genie" | "dashboard" | "scan"
  status      String    @default("generating")
  message     String    @default("")
  percent     Int       @default(0)
  startedAt   DateTime  @map("started_at")
  completedAt DateTime? @map("completed_at")
  error       String?
  domainCount Int       @default(0) @map("domain_count")

  run ForgeRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@unique([runId, engine])
  @@index([runId])
  @@map("forge_background_jobs")
}

// ---------------------------------------------------------------------------
// Exports
// ---------------------------------------------------------------------------

model ForgeExport {
  exportId  String   @id @map("export_id")
  runId     String   @map("run_id")
  format    String
  filePath  String?  @map("file_path")
  createdAt DateTime @default(now()) @map("created_at")

  run ForgeRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@index([runId])
  @@map("forge_exports")
}

// ---------------------------------------------------------------------------
// Environment Scans
// ---------------------------------------------------------------------------

model ForgeEnvironmentScan {
  scanId                String   @id @map("scan_id")
  runId                 String?  @map("run_id")
  ucPath                String   @map("uc_path")
  tableCount            Int      @default(0) @map("table_count")
  totalSizeBytes        BigInt   @default(0) @map("total_size_bytes")
  totalFiles            Int      @default(0) @map("total_files")
  totalRows             BigInt   @default(0) @map("total_rows")
  tablesWithStreaming    Int      @default(0) @map("tables_with_streaming")
  tablesWithCDF         Int      @default(0) @map("tables_with_cdf")
  tablesNeedingOptimize Int      @default(0) @map("tables_needing_optimize")
  tablesNeedingVacuum   Int      @default(0) @map("tables_needing_vacuum")
  lineageDiscoveredCount Int     @default(0) @map("lineage_discovered_count")
  domainCount           Int      @default(0) @map("domain_count")
  piiTablesCount        Int      @default(0) @map("pii_tables_count")
  redundancyPairsCount  Int      @default(0) @map("redundancy_pairs_count")
  dataProductCount      Int      @default(0) @map("data_product_count")
  avgGovernanceScore    Float    @default(0) @map("avg_governance_score")
  scanDurationMs        Int?     @map("scan_duration_ms")
  scanSummaryJson       String?  @map("scan_summary_json")
  passResultsJson       String?  @map("pass_results_json")
  genieSpaceCount       Int      @default(0) @map("genie_space_count")
  dashboardCount        Int      @default(0) @map("dashboard_count")
  metricViewCount       Int      @default(0) @map("metric_view_count")
  analyticsCoveragePercent Float @default(0) @map("analytics_coverage_percent")
  createdAt             DateTime @default(now()) @map("created_at")

  run        ForgeRun? @relation(fields: [runId], references: [runId], onDelete: Cascade)
  details    ForgeTableDetail[]
  histories  ForgeTableHistorySummary[]
  lineage    ForgeTableLineage[]
  insights   ForgeTableInsight[]

  @@index([runId])
  @@index([createdAt])
  @@map("forge_environment_scans")
}

model ForgeTableDetail {
  id                    String   @id @default(uuid())
  scanId                String   @map("scan_id")
  tableFqn              String   @map("table_fqn")
  catalog               String
  schema                String   @map("table_schema")
  tableName             String   @map("table_name")
  tableType             String?  @map("table_type")
  comment               String?
  generatedDescription  String?  @map("generated_description")
  format                String?
  provider              String?
  location              String?
  isManaged             Boolean  @default(true) @map("is_managed")
  owner                 String?
  sizeInBytes           BigInt?  @map("size_in_bytes")
  numFiles              Int?     @map("num_files")
  numRows               BigInt?  @map("num_rows")
  partitionColumns      String?  @map("partition_columns")
  clusteringColumns     String?  @map("clustering_columns")
  deltaMinReaderVersion Int?     @map("delta_min_reader_version")
  deltaMinWriterVersion Int?     @map("delta_min_writer_version")
  cdfEnabled            Boolean  @default(false) @map("cdf_enabled")
  autoOptimize          Boolean  @default(false) @map("auto_optimize")
  tableCreatedAt        String?  @map("table_created_at")
  lastModified          String?  @map("last_modified")
  createdBy             String?  @map("created_by")
  lastAccess            String?  @map("last_access")
  isManagedLocation     Boolean? @map("is_managed_location")
  columnsJson           String?  @map("columns_json")
  propertiesJson        String?  @map("properties_json")
  tagsJson              String?  @map("tags_json")
  columnTagsJson        String?  @map("column_tags_json")
  dataDomain            String?  @map("data_domain")
  dataSubdomain         String?  @map("data_subdomain")
  dataTier              String?  @map("data_tier")
  sensitivityLevel      String?  @map("sensitivity_level")
  governancePriority    String?  @map("governance_priority")
  governanceScore       Float?   @map("governance_score")
  discoveredVia         String   @default("selected") @map("discovered_via")

  scan ForgeEnvironmentScan @relation(fields: [scanId], references: [scanId], onDelete: Cascade)

  @@index([scanId])
  @@index([tableFqn])
  @@index([dataDomain])
  @@index([sensitivityLevel])
  @@map("forge_table_details")
}

model ForgeTableHistorySummary {
  id                   String   @id @default(uuid())
  scanId               String   @map("scan_id")
  tableFqn             String   @map("table_fqn")
  lastWriteTimestamp   String?  @map("last_write_timestamp")
  lastWriteOperation   String?  @map("last_write_operation")
  lastWriteRows        BigInt?  @map("last_write_rows")
  lastWriteBytes       BigInt?  @map("last_write_bytes")
  totalWriteOps        Int      @default(0) @map("total_write_ops")
  totalStreamingOps    Int      @default(0) @map("total_streaming_ops")
  totalOptimizeOps     Int      @default(0) @map("total_optimize_ops")
  totalVacuumOps       Int      @default(0) @map("total_vacuum_ops")
  totalMergeOps        Int      @default(0) @map("total_merge_ops")
  lastOptimizeTimestamp String? @map("last_optimize_timestamp")
  lastVacuumTimestamp  String?  @map("last_vacuum_timestamp")
  hasStreamingWrites   Boolean  @default(false) @map("has_streaming_writes")
  historyDays          Int      @default(0) @map("history_days")
  topOperationsJson    String?  @map("top_operations_json")
  healthScore          Float?   @map("health_score")
  issuesJson           String?  @map("issues_json")
  recommendationsJson  String?  @map("recommendations_json")

  scan ForgeEnvironmentScan @relation(fields: [scanId], references: [scanId], onDelete: Cascade)

  @@index([scanId])
  @@index([tableFqn])
  @@map("forge_table_history_summaries")
}

model ForgeTableLineage {
  id              String   @id @default(uuid())
  scanId          String   @map("scan_id")
  sourceTableFqn  String   @map("source_table_fqn")
  targetTableFqn  String   @map("target_table_fqn")
  sourceType      String?  @map("source_type")
  targetType      String?  @map("target_type")
  entityType      String?  @map("entity_type")
  lastEventTime   String?  @map("last_event_time")
  eventCount      Int      @default(1) @map("event_count")

  scan ForgeEnvironmentScan @relation(fields: [scanId], references: [scanId], onDelete: Cascade)

  @@index([scanId])
  @@index([sourceTableFqn])
  @@index([targetTableFqn])
  @@map("forge_table_lineage")
}

model ForgeTableInsight {
  id          String   @id @default(uuid())
  scanId      String   @map("scan_id")
  insightType String   @map("insight_type")
  tableFqn    String?  @map("table_fqn")
  payloadJson String   @map("payload_json")
  severity    String   @default("info")
  createdAt   DateTime @default(now()) @map("created_at")

  scan ForgeEnvironmentScan @relation(fields: [scanId], references: [scanId], onDelete: Cascade)

  @@index([scanId])
  @@index([insightType])
  @@index([tableFqn])
  @@map("forge_table_insights")
}

// ---------------------------------------------------------------------------
// Discovered Analytics Assets (read-only snapshots from workspace)
// ---------------------------------------------------------------------------

model ForgeDiscoveredGenieSpace {
  id                 String   @id @default(uuid())
  runId              String   @map("run_id")
  spaceId            String   @map("space_id")
  title              String
  description        String?
  tablesJson         String?  @map("tables_json")          // JSON array of FQNs
  metricViewsJson    String?  @map("metric_views_json")    // JSON array of FQNs
  sampleQuestionCount Int     @default(0) @map("sample_question_count")
  measureCount       Int      @default(0) @map("measure_count")
  filterCount        Int      @default(0) @map("filter_count")
  instructionLength  Int      @default(0) @map("instruction_length")
  discoveredAt       DateTime @default(now()) @map("discovered_at")

  run ForgeRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@index([runId])
  @@index([spaceId])
  @@map("forge_discovered_genie_spaces")
}

model ForgeDiscoveredDashboard {
  id                 String   @id @default(uuid())
  runId              String   @map("run_id")
  dashboardId        String   @map("dashboard_id")
  displayName        String   @map("display_name")
  tablesJson         String?  @map("tables_json")          // JSON array of FQNs
  isPublished        Boolean  @default(false) @map("is_published")
  datasetCount       Int      @default(0) @map("dataset_count")
  widgetCount        Int      @default(0) @map("widget_count")
  creatorEmail       String?  @map("creator_email")
  parentPath         String?  @map("parent_path")
  discoveredAt       DateTime @default(now()) @map("discovered_at")

  run ForgeRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@index([runId])
  @@index([dashboardId])
  @@map("forge_discovered_dashboards")
}

// ---------------------------------------------------------------------------
// Metadata Genie Spaces (standalone metadata exploration)
// ---------------------------------------------------------------------------

model ForgeMetadataGenieSpace {
  id              String   @id @default(uuid()) @map("metadata_genie_id")
  title           String   @default("Meta Data Genie")
  catalogScope    String?  @map("catalog_scope")
  industryId      String?  @map("industry_id")
  industryName    String?  @map("industry_name")
  domains         String?
  detection        String?
  sampleQuestions  String?  @map("sample_questions")
  aiDescriptions       String?  @map("ai_descriptions")
  lineageAccessible    Boolean  @default(false) @map("lineage_accessible")
  viewCatalog          String?  @map("view_catalog")
  viewSchema       String?  @map("view_schema")
  viewsDeployed    Boolean  @default(false) @map("views_deployed")
  viewNames        String?  @map("view_names")
  serializedSpace  String?  @map("serialized_space")
  spaceId         String?  @map("space_id")
  spaceUrl        String?  @map("space_url")
  status          String   @default("draft")
  authMode        String   @default("obo") @map("auth_mode")
  tableCount      Int      @default(0) @map("table_count")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("forge_metadata_genie_spaces")
}

model ForgeAssetCoverage {
  id                 String   @id @default(uuid())
  runId              String   @map("run_id")
  totalTables        Int      @default(0) @map("total_tables")
  coveredTables      Int      @default(0) @map("covered_tables")
  uncoveredTables    Int      @default(0) @map("uncovered_tables")
  coveragePercent    Float    @default(0) @map("coverage_percent")
  genieSpaceCount    Int      @default(0) @map("genie_space_count")
  dashboardCount     Int      @default(0) @map("dashboard_count")
  metricViewCount    Int      @default(0) @map("metric_view_count")
  coverageDetailJson String?  @map("coverage_detail_json")  // JSON: full AssetCoverage
  discoveredAt       DateTime @default(now()) @map("discovered_at")

  run ForgeRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@unique([runId])
  @@index([runId])
  @@map("forge_asset_coverages")
}

// ---------------------------------------------------------------------------
// Knowledge Base: Uploaded documents for RAG
// ---------------------------------------------------------------------------

model ForgeDocument {
  id         String   @id @default(uuid()) @map("id")
  filename   String
  mimeType   String   @map("mime_type")
  category   String   @default("other")
  chunkCount Int      @default(0) @map("chunk_count")
  sizeBytes  Int      @map("size_bytes")
  status     String   @default("processing")
  uploadedBy String?  @map("uploaded_by")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([status])
  @@map("forge_documents")
}
