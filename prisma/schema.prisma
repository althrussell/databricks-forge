// Databricks Inspire AI â€” Prisma Schema
//
// Connects to Lakebase Autoscaling (Postgres-compatible).
// Tables store pipeline run state, discovered use cases, and export history.

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ---------------------------------------------------------------------------
// Pipeline Runs
// ---------------------------------------------------------------------------

model InspireRun {
  runId              String    @id @map("run_id")
  businessName       String    @map("business_name")
  ucMetadata         String    @map("uc_metadata")
  operation          String    @default("Discover Usecases")
  businessPriorities String?   @map("business_priorities")
  strategicGoals     String?   @map("strategic_goals")
  businessDomains    String?   @map("business_domains")
  aiModel            String?   @default("databricks-claude-sonnet-4-5") @map("ai_model")
  languages          String?   @default("[\"English\"]")
  generationOptions  String?   @default("[\"SQL Code\"]") @map("generation_options")
  generationPath     String?   @default("./inspire_gen/") @map("generation_path")
  status             String    @default("pending")
  currentStep        String?   @map("current_step")
  progressPct        Int       @default(0) @map("progress_pct")
  statusMessage      String?   @map("status_message")
  businessContext    String?   @map("business_context")
  errorMessage       String?   @map("error_message")
  createdAt          DateTime  @default(now()) @map("created_at")
  completedAt        DateTime? @map("completed_at")

  createdBy          String?   @map("created_by")
  filteredTablesJson String?   @map("filtered_tables_json")
  metadataCacheKey   String?   @map("metadata_cache_key")

  useCases             InspireUseCase[]
  exports              InspireExport[]
  promptLogs           InspirePromptLog[]
  genieRecommendations InspireGenieRecommendation[]
  genieSpaces          InspireGenieSpace[]

  @@map("inspire_runs")
}

// ---------------------------------------------------------------------------
// Use Cases
// ---------------------------------------------------------------------------

model InspireUseCase {
  id                 String  @id
  runId              String  @map("run_id")
  useCaseNo          Int?    @map("use_case_no")
  name               String?
  type               String?
  analyticsTechnique String? @map("analytics_technique")
  statement          String?
  solution           String?
  businessValue      String? @map("business_value")
  beneficiary        String?
  sponsor            String?
  domain             String?
  subdomain          String?
  tablesInvolved     String? @map("tables_involved")
  priorityScore      Float?  @map("priority_score")
  feasibilityScore   Float?  @map("feasibility_score")
  impactScore        Float?  @map("impact_score")
  overallScore       Float?  @map("overall_score")
  sqlCode            String? @map("sql_code")
  sqlStatus          String? @map("sql_status")

  run InspireRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@index([runId])
  @@map("inspire_use_cases")
}

// ---------------------------------------------------------------------------
// Prompt Audit Log
// ---------------------------------------------------------------------------

model InspirePromptLog {
  logId          String   @id @map("log_id")
  runId          String   @map("run_id")
  step           String
  promptKey      String   @map("prompt_key")
  promptVersion  String   @map("prompt_version")
  model          String
  temperature    Float
  renderedPrompt String   @map("rendered_prompt")
  rawResponse    String?  @map("raw_response")
  honestyScore   Float?   @map("honesty_score")
  durationMs     Int?     @map("duration_ms")
  success        Boolean  @default(true)
  errorMessage   String?  @map("error_message")
  createdAt      DateTime @default(now()) @map("created_at")

  run InspireRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@index([runId])
  @@index([runId, step])
  @@map("inspire_prompt_logs")
}

// ---------------------------------------------------------------------------
// Activity Log
// ---------------------------------------------------------------------------

model InspireActivityLog {
  activityId String   @id @map("activity_id")
  userId     String?  @map("user_id")
  action     String                              // created_run, deleted_run, exported, started_pipeline, completed, failed
  resourceId String?  @map("resource_id")        // runId or exportId
  metadata   String?                             // JSON metadata
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([resourceId])
  @@map("inspire_activity_log")
}

// ---------------------------------------------------------------------------
// Metadata Cache
// ---------------------------------------------------------------------------

model InspireMetadataCache {
  cacheKey     String   @id @map("cache_key")
  ucPath       String?  @map("uc_path")
  metadataJson String?  @map("metadata_json")
  tableCount   Int?     @map("table_count")
  columnCount  Int?     @map("column_count")
  cachedAt     DateTime @default(now()) @map("cached_at")

  @@index([cachedAt])
  @@map("inspire_metadata_cache")
}

// ---------------------------------------------------------------------------
// Custom Outcome Maps
// ---------------------------------------------------------------------------

model InspireOutcomeMap {
  id           String   @id @map("outcome_map_id")
  industryId   String   @unique @map("industry_id")
  name         String
  rawMarkdown  String   @map("raw_markdown")
  parsedJson   String   @map("parsed_json")
  useCaseCount Int      @default(0) @map("use_case_count")
  createdBy    String?  @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([createdAt])
  @@map("inspire_outcome_maps")
}

// ---------------------------------------------------------------------------
// Genie Space Recommendations (generated in pipeline)
// ---------------------------------------------------------------------------

model InspireGenieRecommendation {
  id              String   @id @map("recommendation_id")
  runId           String   @map("run_id")
  domain          String
  subdomains      String?                              // JSON array
  title           String
  description     String
  tableCount      Int      @default(0) @map("table_count")
  metricViewCount Int      @default(0) @map("metric_view_count")
  useCaseCount    Int      @default(0) @map("use_case_count")
  sqlExampleCount Int      @default(0) @map("sql_example_count")
  joinCount       Int      @default(0) @map("join_count")
  measureCount    Int      @default(0) @map("measure_count")
  filterCount     Int      @default(0) @map("filter_count")
  dimensionCount  Int      @default(0) @map("dimension_count")
  tables          String?                              // JSON array of FQNs
  metricViews     String?  @map("metric_views")        // JSON array of FQNs
  serializedSpace String   @map("serialized_space")    // JSON for Genie API
  createdAt       DateTime @default(now()) @map("created_at")

  run InspireRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@unique([runId, domain])
  @@index([runId])
  @@map("inspire_genie_recommendations")
}

// ---------------------------------------------------------------------------
// Genie Spaces (tracking)
// ---------------------------------------------------------------------------

model InspireGenieSpace {
  id        String   @id @map("genie_tracking_id")
  spaceId   String   @map("space_id")
  runId     String   @map("run_id")
  domain    String
  title     String
  status    String   @default("created") // created | updated | trashed
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  run InspireRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@unique([runId, domain])
  @@index([runId])
  @@index([spaceId])
  @@map("inspire_genie_spaces")
}

// ---------------------------------------------------------------------------
// Exports
// ---------------------------------------------------------------------------

model InspireExport {
  exportId  String   @id @map("export_id")
  runId     String   @map("run_id")
  format    String
  filePath  String?  @map("file_path")
  createdAt DateTime @default(now()) @map("created_at")

  run InspireRun @relation(fields: [runId], references: [runId], onDelete: Cascade)

  @@index([runId])
  @@map("inspire_exports")
}
